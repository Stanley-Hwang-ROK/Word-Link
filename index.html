<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Word-Link Puzzle ‚Äî Pastel 3D Edition</title>
  
  <link rel="manifest" href="manifest.json?v=11">
  <link rel="apple-touch-icon" href="ICON-192.png">
  <meta name="theme-color" content="#f5f7fa">

  <style>
    :root { --bg:#f5f7fa; --panel:#ffffff; --text:#111; }

    body {
      margin:0; font-family: system-ui, -apple-system, sans-serif;
      background:var(--bg); color:var(--text);
      min-height:100vh; display:flex;
      overscroll-behavior: none; user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .wrap { margin:auto; width:min(95vw, 500px); padding: 0 10px; }

    header { display:flex; justify-content:space-between; align-items:center; padding:12px 0; }
    h1 { font-size: 1.2rem; margin: 0; }

    .board {
      display:grid; gap:6px; padding:10px;
      grid-template-columns:repeat(8, 1fr);
      justify-content:center;
      background: #eef2f6; border-radius: 16px;
      box-shadow: inset 4px 4px 8px rgba(0,0,0,0.05), inset -4px -4px 8px rgba(255,255,255,0.8);
    }

    .tile {
      width:100%; aspect-ratio: 1/1; display:grid; place-items:center;
      border-radius:12px;
      background: linear-gradient(145deg, rgba(255,255,255,0.6), rgba(0,0,0,0.05)), var(--tileColor);
      font-size: clamp(12px, 4vw, 22px); font-weight:900; color:#1a1a1a;
      user-select:none; border:1px solid rgba(255,255,255,0.4);
      box-shadow: 3px 3px 6px rgba(166, 180, 200, 0.4), -3px -3px 6px rgba(255,255,255, 0.8);
      transition:transform .12s ease, box-shadow .12s ease;
      cursor: pointer; touch-action: manipulation;
    }

    .tile.sel {
      transform:scale(0.95);
      box-shadow: inset 3px 3px 6px rgba(166, 180, 200, 0.5), inset -3px -3px 6px rgba(255,255,255, 0.8);
      border-color: #2563eb;
    }

    .tile.match {
      transform:scale(1.1);
      background: linear-gradient(145deg, #FFF4C7, #FFD76A);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
      z-index: 10;
    }

    .hud { display:flex; gap:8px; margin:10px 0; justify-content: center; }
    .badge {
      background:#ffffff; padding:6px 12px; border-radius:999px;
      font-weight:700; font-size: 0.9rem; border:1px solid #e2e8f0;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
    }
    .msg { text-align: center; min-height:24px; opacity:.8; margin-top:10px; font-size: 0.9rem; }

    .category-btn {
      width: 100%; padding:14px; margin:6px 0; border-radius:12px;
      background:#2563eb; border:none; font-size:16px; font-weight: bold;
      color:white; cursor:pointer; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
    }
    
    button { font-family: inherit; }
    #header-btns button {
      padding: 8px 12px; border-radius: 8px; border: 1px solid #cbd5e1;
      background: white; font-weight: 600; color: #334155; cursor: pointer;
    }

    #moves { color:#d97706; font-weight:900; transition:transform .15s ease; display: inline-block; }
    #moves.bump { transform:scale(1.4); color: #dc2626; }

    #gameover-overlay {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:rgba(15, 23, 42, 0.9); display:none; flex-direction:column;
      justify-content:center; align-items:center; z-index:9999;
      animation: fadeIn .8s ease forwards;
    }
    #gameover-text {
      font-size:3rem; font-weight:900; color:#facc15;
      text-shadow:0 0 30px rgba(250, 204, 21, 0.5);
      animation:pulse 1s infinite alternate;
    }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    @keyframes pulse { from { transform:scale(0.95); opacity:.8; } to { transform:scale(1.05); opacity:1; } }

    #btnRestart {
      margin-top:30px; padding:16px 32px; font-size:1.2rem;
      border-radius:12px; background:#2563eb; color:white; border:none;
      cursor:pointer; font-weight: bold; box-shadow: 0 0 20px rgba(37, 99, 235, 0.5);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Word-Link 3D</h1>
      <div id="header-btns">
        <button id="btnShuffle">Mix</button>
        <button id="btnNew">Reset</button>
      </div>
    </header>

    <div id="category-menu" style="text-align:center; margin: auto 0;">
      <h2 style="color:#475569;">Select Category</h2>
      <button class="category-btn" data-cat="animal">üê∂ Animals</button>
      <button class="category-btn" data-cat="plant">üåø Plants</button>
      <button class="category-btn" data-cat="jobs">üë®‚Äç‚öïÔ∏è Jobs</button>
    </div>

    <div class="hud">
      <div class="badge">Score: <span id="score">0</span></div>
      <div class="badge">Moves: <span id="moves">10</span></div>
      <div class="badge">Dict: <span id="dictCount">0</span></div>
    </div>

    <div id="board" class="board"></div>
    <div id="msg" class="msg">Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</div>
  </div>

  <div id="gameover-overlay">
    <div id="gameover-text">GAME OVER</div>
    <button id="btnRestart">TRY AGAIN</button>
  </div>


<script>
/* ======================
   üîä SOUND EFFECTS (Web Audio API)
====================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// 1. ÌÉÄÏùº Ïä§Ïôë ÏÜåÎ¶¨ (ÎΩÅ!)
function playPopSound() {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(500, audioCtx.currentTime); 
  osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
  gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}

// 2. Îã®Ïñ¥ Îß§Ïπ≠ ÏÑ±Í≥µ ÏÜåÎ¶¨ (Îî©Îèô! - ÎßëÏùÄ ÏÜåÎ¶¨)
function playMatchSound() {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  
  osc.type = 'sine'; 
  // ÎÜíÏùÄ ÏùåÏóêÏÑú ÏÇ¥Ïßù Îñ®Ïñ¥ÏßÄÎ©∞ Ïó¨Ïö¥ (ÏÑ±Í≥µ ÎäêÎÇå)
  osc.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
  osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.6); 

  gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);

  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 0.6);
}

/* ======================
   TTS (Í≥†ÌíàÏßà ÏùåÏÑ±)
====================== */
let voices = [];
function loadVoices() { voices = window.speechSynthesis.getVoices(); }
if (window.speechSynthesis) {
  if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();
}

function speakWord(word){
  if (!window.speechSynthesis) return;
  if (voices.length === 0) loadVoices();
  const u = new SpeechSynthesisUtterance(word);
  u.lang = "en-US"; u.rate = 0.85; u.pitch = 1.0;
  const targetVoice = voices.find(v => v.name.includes("Google US English")) || 
                      voices.find(v => v.name.includes("Samantha")) || 
                      voices.find(v => v.name.includes("Aaron")) ||
                      voices.find(v => v.lang === "en-US" && !v.name.includes("Microsoft"));
  if (targetVoice) u.voice = targetVoice;
  speechSynthesis.speak(u);
}

/* ======================
   GAME LOGIC
====================== */
const ROWS=10, COLS=8, MIN_WORD=3, MAX_WORD=6;
const COLORS=["#CDE9FF", "#FFE4E4", "#FFF4C7", "#DFFFE3", "#EADFFF", "#FFE8D6", "#E4F1FF", "#FFFBE6"];

const CATEGORY_WORDS={
  animal:["CAT","DOG","LION","TIGER","BEAR","FROG","BIRD","FISH","COW","PIG","FOX","DEER","BEE","DUCK","WOLF"],
  plant:["TREE","LEAF","ROSE","GRASS","SEED","FLOWER","ROOT","MOSS","BAMBOO","OAK","PINE","LILY"],
  jobs:["DOCTOR","NURSE","TEACHER","PILOT","CHEF","FARMER","POLICE","DRIVER","ARTIST","BAKER","CLERK","GUIDE"]
};

let LETTER_BAG="";
function buildLetterBag(list){ return list.join(""); }
let DICTIONARY=new Set();
let grid=Array.from({length:ROWS},()=>Array(COLS).fill(""));
let colorGrid=Array.from({length:ROWS},()=>Array(COLS).fill(""));
let score=0, moves=10, firstSel=null;

const elBoard=document.getElementById("board");
const elScore=document.getElementById("score");
const elMoves=document.getElementById("moves");
const elMsg=document.getElementById("msg");
const elDict=document.getElementById("dictCount");

/* UI UPDATE */
function updateScore(){ elScore.textContent=score; }
function updateMoves(){
  elMoves.textContent=moves;
  elMoves.classList.add("bump");
  setTimeout(()=>elMoves.classList.remove("bump"),150);
}
function setMsg(t){ elMsg.textContent=t; }

/* BOARD SETUP */
function randLetter(){
  if(LETTER_BAG.length) return LETTER_BAG[Math.floor(Math.random()*LETTER_BAG.length)];
  const bag="EEEEEEAAA AAI IIOOOUU"+"NNNRRRTTTLLSS"+"DGGBCMPFHVWYKJXQZ";
  const letters=bag.replace(/\s/g,"");
  return letters[Math.floor(Math.random()*letters.length)];
}

function setupBoard(){
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      grid[r][c]=randLetter();
      colorGrid[r][c]=COLORS[Math.floor(Math.random()*COLORS.length)];
    }
  }
}

function renderAll(){
  elBoard.innerHTML="";
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const d=document.createElement("div");
      d.className="tile";
      d.dataset.r=r; d.dataset.c=c;
      d.textContent=grid[r][c];
      d.style.setProperty("--tileColor", colorGrid[r][c]);
      elBoard.appendChild(d);
    }
  }
}

/* EVENTS */
bindEvents();
function bindEvents(){
  document.getElementById("btnShuffle").onclick=shuffleBoard;
  document.getElementById("btnNew").onclick=()=>{
    resetGame();
    document.getElementById("category-menu").style.display="block";
    setMsg("Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
  };
  document.getElementById("btnRestart").onclick=()=>{
    document.getElementById("gameover-overlay").style.display="none";
    resetGame();
    document.getElementById("category-menu").style.display="block";
    setMsg("Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
  };
  document.querySelectorAll(".category-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const cat=btn.dataset.cat;
      DICTIONARY=new Set(CATEGORY_WORDS[cat]);
      LETTER_BAG=buildLetterBag(CATEGORY_WORDS[cat]);
      elDict.textContent=DICTIONARY.size;
      document.getElementById("category-menu").style.display="none";
      startGame();
    });
  });
  elBoard.addEventListener("click",onClickTile);
}

function resetGame() {
  score=0; updateScore(); moves=10; updateMoves(); firstSel=null;
  grid=Array.from({length:ROWS},()=>Array(COLS).fill(""));
  colorGrid=Array.from({length:ROWS},()=>Array(COLS).fill(""));
  renderAll();
}
function startGame() {
  score=0; updateScore(); moves=10; updateMoves();
  setupBoard(); renderAll(); setMsg(`Game Started! (${DICTIONARY.size} words)`);
}

/* INTERACTION */
async function onClickTile(e){
  if(moves<=0){ gameOver(); return; }
  const t=e.target.closest(".tile");
  if(!t) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();

  const r=+t.dataset.r, c=+t.dataset.c;
  if(!firstSel){
    firstSel={r,c}; highlight(r,c,true); return;
  }
  if(firstSel.r===r && firstSel.c===c){
    highlight(r,c,false); firstSel=null; return;
  }
  if(!isNeighbor(firstSel.r,firstSel.c,r,c)){
    highlight(firstSel.r,firstSel.c,false);
    firstSel={r,c}; highlight(r,c,true); return;
  }

  // üîä Ïä§Ïôë ÏÜåÎ¶¨
  swap([firstSel.r,firstSel.c],[r,c]);
  playPopSound(); 

  highlight(firstSel.r,firstSel.c,false);
  highlight(r,c,false);
  firstSel=null;

  moves--; updateMoves();
  if(moves<=0){
    renderAll();
    const marks = findMatches();
    if(marks.size > 0) await resolveMatchesCascade();
    else gameOver();
    return;
  }
  renderAll();
  await resolveMatchesCascade();
}

function highlight(r,c,on){
  const el=document.querySelector(`[data-r="${r}"][data-c="${c}"]`);
  if(el) el.classList.toggle("sel",on);
}
function isNeighbor(r1,c1,r2,c2){ return Math.abs(r1-r2)+Math.abs(c1-c2)==1; }
function swap([r1,c1],[r2,c2]){
  [grid[r1][c1],grid[r2][c2]]=[grid[r2][c2],grid[r1][c1]];
  [colorGrid[r1][c1],colorGrid[r2][c2]]=[colorGrid[r2][c2],colorGrid[r1][c1]];
}
function gameOver(){
  setMsg("Game Over!");
  document.getElementById("gameover-overlay").style.display="flex";
}

/* MATCHING */
async function resolveMatchesCascade(){
  let total=0, lastWord="";
  while(true){
    const marks=findMatches();
    if(marks.size===0) break;
    const res=await clearMarked(marks);
    total+=res.count;
    if(res.exampleWord) lastWord=res.exampleWord;
    applyGravity(); refill(); renderAll();
  }
  if(total>0){
    score+=total*5; updateScore();
    if(lastWord) speakWord(lastWord);
    moves+=2; updateMoves();
    setMsg(lastWord? `Found: ${lastWord} (+2 moves)` : `Cleared ${total}`);
  }
}
function findMatches(){
  const marks=new Set(); let example="";
  for(let r=0;r<ROWS;r++){
    let c=0;
    while(c<COLS){
      let c2=c;
      while(c2+1<COLS && grid[r][c2+1]) c2++;
      if(c2-c+1>=MIN_WORD){
        const letters=grid[r].slice(c,c2+1).join("");
        markStrip(r,c,0,1,letters,marks,w=>example||=w);
      }
      c=c2+1;
    }
  }
  for(let c=0;c<COLS;c++){
    let r=0;
    while(r<ROWS){
      let r2=r;
      while(r2+1<ROWS && grid[r2+1][c]) r2++;
      if(r2-r+1>=MIN_WORD){
        let str="";
        for(let i=r;i<=r2;i++) str+=grid[i][c];
        markStrip(r,c,1,0,str,marks,w=>example||=w);
      }
      r=r2+1;
    }
  }
  marks.exampleWord=example; return marks;
}
function markStrip(r0,c0,dr,dc,str,marks,onExample){
  const n=str.length;
  for(let len=MIN_WORD; len<=Math.min(n,MAX_WORD); len++){
    for(let s=0; s+len<=n; s++){
      const word=str.slice(s,s+len).toUpperCase();
      if(DICTIONARY.has(word)){
        for(let k=0;k<len;k++) marks.add(`${r0+(s+k)*dr},${c0+(s+k)*dc}`);
        if(onExample) onExample(word);
      }
    }
  }
}
async function clearMarked(marks){
  const exampleWord=marks.exampleWord||"";
  
  // üîä Ïó¨Í∏∞ÏÑú ÏÑ±Í≥µ ÏÜåÎ¶¨ Ïû¨ÏÉù! (ÏãúÍ∞Å Ìö®Í≥º ÏãúÏûëÍ≥º ÎèôÏãúÏóê)
  playMatchSound();

  for(const pos of marks){
    const[r,c]=pos.split(",").map(Number);
    const el=document.querySelector(`[data-r="${r}"][data-c="${c}"]`);
    if(el) el.classList.add("match");
  }
  await new Promise(res=>setTimeout(res,500));
  let count=0;
  for(const pos of marks){
    const[r,c]=pos.split(",").map(Number);
    if(grid[r][c]){ grid[r][c]=""; count++; }
  }
  renderAll(); return {count, exampleWord};
}
function applyGravity(){
  for(let c=0;c<COLS;c++){
    let w=ROWS-1;
    for(let r=ROWS-1;r>=0;r--){
      if(grid[r][c]){
        grid[w][c]=grid[r][c];
        if(w!==r) grid[r][c]="";
        w--;
      }
    }
  }
}
function refill(){
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(!grid[r][c]){
        grid[r][c]=randLetter();
        colorGrid[r][c]=COLORS[Math.floor(Math.random()*COLORS.length)];
      }
    }
  }
}
function shuffleBoard(){
  const arr=[];
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) arr.push({ char: grid[r][c], color: colorGrid[r][c] });
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  let k=0;
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) {
    grid[r][c]=arr[k].char; colorGrid[r][c]=arr[k].color; k++;
  }
  renderAll(); setMsg("Shuffled!");
}

/* SERVICE WORKER */
const canSW='serviceWorker' in navigator && (location.protocol==='https:'||location.hostname==='localhost'||location.hostname==='127.0.0.1');
if(canSW){
  navigator.serviceWorker.register('sw.js').then(reg=>{
    let refreshing=false;
    navigator.serviceWorker.addEventListener('controllerchange',()=>{
      if(refreshing)return; refreshing=true; location.reload();
    });
  }).catch(console.error);
}
</script>
</body>
</html>
